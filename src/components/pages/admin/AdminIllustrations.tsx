import { useState } from "react";
import { useLoaderData } from "react-router-dom";
import {
  useAdminIllustrations,
  useAdminIllustrationTags,
} from "../../../hooks/useAdminIllustrations";
import { usePagination } from "../../../hooks/usePagination";
import type {
  AdminIllustration,
  AdminIllustrationsPageData, // ‚úÖ Import du type depuis admin.ts
  AdminTag,
  CreateIllustrationData,
} from "../../../types/admin";
import AdminIllustrationCard from "../../molecules/AdminIllustrationCard";
import AdminIllustrationForm from "../../molecules/AdminIllustrationForm";
import Pagination from "../../molecules/Pagination";

import "./AdminIllustrations.css";

function AdminIllustrations() {
  console.info("üîç [COMPONENT ILLUSTRATIONS] Rendu du composant");

  // ‚úÖ Utiliser useLoaderData avec le type correct
  const loaderData = useLoaderData() as AdminIllustrationsPageData;
  console.info("üîç [AdminIllustrations] Donn√©es du loader:", loaderData);

  const {
    illustrations: loaderIllustrations,
    pagination: loaderPagination,
    tags: loaderTags,
  } = loaderData;
  console.info(
    "üîç [AdminIllustrations] Illustrations du loader:",
    loaderIllustrations,
  );
  console.info(
    "üîç [AdminIllustrations] Pagination du loader:",
    loaderPagination,
  );
  console.info("üîç [AdminIllustrations] Tags du loader:", loaderTags);

  const [showForm, setShowForm] = useState(false);
  const [editingIllustration, setEditingIllustration] = useState<number | null>(
    null,
  );
  const [formData, setFormData] = useState<CreateIllustrationData>({
    title: "",
    description: "",
    image: "",
    alt_text: "",
    is_in_gallery: true,
    tagIds: [],
  });

  // Hook de pagination
  const { limit, offset, currentPage, handlePageChange } = usePagination(12);
  console.info("üîç [COMPONENT ILLUSTRATIONS] Pagination:", {
    limit,
    offset,
    currentPage,
  });

  // ‚úÖ Hooks SWR avec fallback
  const {
    illustrations: swrIllustrations,
    pagination: swrPagination,
    isLoading,
    error,
    createIllustration,
    updateIllustration,
    deleteIllustration,
  } = useAdminIllustrations(limit, offset);

  console.info("üîç [AdminIllustrations] SWR Illustrations:", swrIllustrations);
  console.info("üîç [AdminIllustrations] SWR Pagination:", swrPagination);
  console.info("üîç [AdminIllustrations] SWR IsLoading:", isLoading);
  console.info("üîç [AdminIllustrations] SWR Error:", error);

  const { tags: swrTags } = useAdminIllustrationTags();
  console.info("üîç [AdminIllustrations] SWR Tags:", swrTags);

  // ‚úÖ Utiliser les donn√©es SWR ou fallback vers le loader
  const currentIllustrations =
    swrIllustrations.length > 0 ? swrIllustrations : loaderIllustrations;
  const currentPagination = swrPagination || loaderPagination;
  const currentTags = swrTags.length > 0 ? swrTags : loaderTags;

  console.info(
    "üîç [AdminIllustrations] Illustrations finaux:",
    currentIllustrations,
  );
  console.info("üîç [AdminIllustrations] Pagination finale:", currentPagination);
  console.info("üîç [AdminIllustrations] Tags finaux:", currentTags);
  console.info(
    "üîç [AdminIllustrations] Nombre d'illustrations √† afficher:",
    currentIllustrations.length,
  );

  const handleCreate = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      await createIllustration(formData);
      setFormData({
        title: "",
        description: "",
        image: "",
        alt_text: "",
        is_in_gallery: true,
        tagIds: [],
      });
      setShowForm(false);
    } catch (error) {
      console.error("Erreur cr√©ation illustration:", error);
    }
  };

  const handleUpdate = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!editingIllustration) return;

    try {
      await updateIllustration(editingIllustration, formData);
      setEditingIllustration(null);
      setFormData({
        title: "",
        description: "",
        image: "",
        alt_text: "",
        is_in_gallery: true,
        tagIds: [],
      });
      setShowForm(false);
    } catch (error) {
      console.error("Erreur modification illustration:", error);
    }
  };

  const handleEdit = (illustration: AdminIllustration) => {
    setFormData({
      title: illustration.title,
      description: illustration.description || "",
      image: illustration.image,
      alt_text: illustration.alt_text,
      is_in_gallery: illustration.is_in_gallery,
      tagIds: illustration.tags.map((tag: AdminTag) => tag.id),
    });
    setEditingIllustration(illustration.id);
    setShowForm(true);
  };

  const handleDelete = async (id: number) => {
    if (confirm("√ätes-vous s√ªr de vouloir supprimer cette illustration ?")) {
      try {
        await deleteIllustration(id);
      } catch (error) {
        console.error("Erreur suppression illustration:", error);
      }
    }
  };

  const handleCancel = () => {
    setShowForm(false);
    setEditingIllustration(null);
    setFormData({
      title: "",
      description: "",
      image: "",
      alt_text: "",
      is_in_gallery: true,
      tagIds: [],
    });
  };

  // ‚úÖ Afficher le loading seulement si on n'a pas de donn√©es du loader
  if (isLoading && loaderIllustrations.length === 0) {
    console.info("üîç [AdminIllustrations] Affichage du loading");
    return (
      <main className="admin-illustrations-page">
        <section className="admin-loading">
          <div className="spinner"></div>
          <p>Chargement des illustrations...</p>
        </section>
      </main>
    );
  }

  // ‚úÖ Afficher l'erreur seulement si on n'a pas de donn√©es du loader
  if (error && loaderIllustrations.length === 0) {
    console.info("üîç [AdminIllustrations] Affichage de l'erreur:", error);
    return (
      <main className="admin-illustrations-page">
        <section className="admin-error">
          <p>Erreur lors du chargement des illustrations.</p>
        </section>
      </main>
    );
  }

  console.info(
    "üîç [AdminIllustrations] Rendu de la page avec",
    currentIllustrations.length,
    "illustrations",
  );

  return (
    <main className="admin-illustrations-page">
      {/* Header avec bouton - affich√© seulement si le formulaire n'est pas visible */}
      {!showForm && (
        <header className="admin-page-header">
          <h1>Gestion des Illustrations</h1>
          <button
            type="button"
            onClick={() => setShowForm(true)}
            className="admin-new-illustration-btn"
          >
            Nouvelle Illustration
          </button>
        </header>
      )}

      {/* Formulaire - affich√© seulement si showForm est true */}
      {showForm && (
        <section className="admin-form-section">
          <header className="admin-form-header">
            <h1>
              {editingIllustration
                ? "Modifier l'illustration"
                : "Nouvelle Illustration"}
            </h1>
          </header>
          <AdminIllustrationForm
            formData={formData}
            setFormData={setFormData}
            tags={currentTags}
            onSubmit={editingIllustration ? handleUpdate : handleCreate}
            onCancel={handleCancel}
            isEditing={!!editingIllustration}
          />
        </section>
      )}

      {/* Liste et pagination - affich√©es seulement si le formulaire n'est pas visible */}
      {!showForm && (
        <>
          {/* Pagination d√©plac√©e en haut */}
          {currentPagination && currentPagination.totalPages > 1 && (
            <Pagination
              currentPage={currentPage}
              totalPages={currentPagination.totalPages}
              onPageChange={(page) => handlePageChange(page, currentPagination)}
            />
          )}

          <section className="admin-illustrations-grid">
            {currentIllustrations.length === 0 ? (
              <p>Aucune illustration trouv√©e</p>
            ) : (
              currentIllustrations.map((illustration: AdminIllustration) => {
                console.info(
                  "üîç [AdminIllustrations] Rendu de l'illustration:",
                  illustration.id,
                  illustration.title,
                );
                return (
                  <AdminIllustrationCard
                    key={illustration.id}
                    illustration={illustration}
                    onEdit={handleEdit}
                    onDelete={handleDelete}
                  />
                );
              })
            )}
          </section>
        </>
      )}
    </main>
  );
}

export default AdminIllustrations;
